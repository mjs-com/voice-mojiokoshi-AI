# 指いらず - アプリ作成計画書

## 1. プロジェクト概要

### 1.1 アプリ名
**指いらず**

### 1.2 コンセプト
任意のショートカットキーを押すだけで、話した内容がリアルタイムで文字起こしされ、フィラー語の除去・句読点付与・書き言葉化などのAI整形を経て、カーソル位置に直接挿入されるWindows常駐型AI音声入力アプリ。

### 1.3 目指す姿
Aqua Voice・Typeless・Voice OSのような「話した意図を理解して整った文章に変換する」体験を、月額1,500円以下（実質100円以下を目標）のコストで実現する。

### 1.4 競合との差別化
| 項目 | Aqua Voice | Typeless | 指いらず |
|---|---|---|---|
| 価格 | 年額96ドル（約14,000円） | 月額12ドル（約1,800円） | **月額100円以下（実質無料枠で運用可）** |
| STTモジュール | 独自モデル Avalon | 非公開 | **モジュール設計で差し替え可能** |
| LLMモジュール | 独自 | 非公開 | **Gemini / OpenAI / Claude 切り替え可能** |
| カスタマイズ性 | 低い | 低い | **プロンプト・モデル・キー割当を自由に設定** |

---

## 2. 要件定義

### 2.1 機能要件

#### 必須機能（Phase 1）
| ID | 機能 | 説明 |
|---|---|---|
| F-01 | プッシュトゥトーク | 割り当てキー長押しで録音開始、離すと録音停止→AI整形→結果挿入 |
| F-02 | ハンズフリーモード | 割り当てキー1回押しで録音開始、もう1回押すと録音停止→AI整形→結果挿入 |
| F-03 | リアルタイム文字起こし | 録音中、STTによる生テキストをリアルタイムで画面に表示 |
| F-04 | AI文章整形 | 録音停止後、生テキスト全文をLLMに送信し、整形済みテキストを取得 |
| F-05 | カーソル位置直接挿入 | テキストボックスにカーソルがある場合、整形済みテキストをカーソル位置に直接挿入 |
| F-06 | フォールバックポップアップ | テキストボックス未選択時、画面中央下にコピーボタン付きポップアップを表示 |
| F-07 | ショートカットキー占拠 | Low-Level Keyboard Hookにより、割り当てキーを他アプリより最優先で占拠（suppress） |
| F-08 | システムトレイ常駐 | タスクバー右下にアイコンとして常駐、右クリックメニューから操作 |
| F-09 | PC起動時の自動起動 | Windowsスタートアップに登録し、PC起動時にバックグラウンドで自動起動 |
| F-10 | 設定画面 | ショートカットキー割り当て、LLMプロバイダー/モデル選択、APIキー入力、プロンプト編集 |

#### 拡張機能（Phase 2以降）
| ID | 機能 | 説明 |
|---|---|---|
| F-11 | 文脈判定整形 | 入力先アプリや文脈を判定し、ビジネスメール/Markdown/カジュアル等のスタイルで自動整形 |
| F-12 | 履歴管理 | 過去の文字起こし結果を一覧表示・検索・再利用 |
| F-13 | ユーザー辞書 | 固有名詞や専門用語の変換ルールをユーザーが登録可能 |
| F-14 | 録音インジケーター | 録音中の音声レベルメーター表示 |
| F-15 | 多言語対応 | 日本語以外の音声認識・整形対応 |

### 2.2 非機能要件

| 項目 | 要件 |
|---|---|
| リアルタイム性 | STTの生テキスト表示は発話から1秒以内 |
| 整形速度 | LLM整形は録音停止から2秒以内に完了 |
| コスト | 月額1,500円以下（目標: 無料枠内で運用、超過時も月100円以下） |
| PC負荷 | バックグラウンド常駐時のCPU/メモリ消費を最小限に抑える |
| 安定性 | 長時間起動しても動作が不安定にならない |
| 優先順位 | 使いやすさ > セキュリティ（ただしAPIキーの安全な管理は行う） |

---

## 3. アーキテクチャ設計

### 3.1 全体フロー

```
[PC起動] → 指いらず自動起動 → システムトレイ常駐（バックグラウンド）

■ プッシュトゥトークモード
  [キー長押し] → 録音開始 → STTリアルタイム表示
  [キー離す]   → 録音停止 → LLM整形(1〜2秒) → カーソル位置に挿入

■ ハンズフリーモード
  [キー1回押し]     → 録音開始 → STTリアルタイム表示
  [もう1回キー押し] → 録音停止 → 全文脈を踏まえてLLM整形 → カーソル位置に挿入

■ テキストボックス未選択時
  → 画面中央下にフローティングポップアップ（コピーボタン付き）
```

### 3.2 2段階ハイブリッド方式

本アプリは **「ローカルSTT（コスト0円・即時）+ クラウドLLM整形（低コスト・高品質）」** の2段階方式を採用する。

```
[マイク入力]
  ↓ Stage 1: ローカルSTT（即時・コスト0円・PC負荷最小）
[生テキスト] → リアルタイム表示
  ↓ Stage 2: クラウドLLM整形（1〜2秒・月100円以下）
[整形済みテキスト] → カーソル位置に挿入
```

#### 設計根拠
- STTの精度は完璧でなくてよい。LLMが後段で「フィラー除去」「句読点付与」「漢字修正」「書き言葉化」を行う
- STTの弱点（フィラー語・句読点不在・話し言葉）はLLMが最も得意とする修正カテゴリ
- 学術研究でもLLM後処理による誤単語率67%削減が実証済み（喋ラボ, 2025年）

### 3.3 モジュール構成

```
┌─────────────────────────────────────────────────────┐
│  指いらず                                            │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [入力モジュール] input_manager                      │
│    ├─ ホットキー管理（Low-Level Hook + suppress）    │
│    ├─ モードA: プッシュトゥトーク                     │
│    └─ モードB: ハンズフリー                           │
│                                                     │
│  [音声キャプチャモジュール] audio_capture              │
│    └─ マイク入力の取得・バッファリング                 │
│                                                     │
│  [STTモジュール] stt_engine ※差し替え可能             │
│    ├─ Windows標準STT（デフォルト）                    │
│    ├─ Faster Whisper（オプション）                    │
│    └─ Google STT API（オプション）                    │
│                                                     │
│  [LLM整形モジュール] llm_formatter ※差し替え可能     │
│    ├─ Gemini 2.5 Flash-Lite（デフォルト）             │
│    ├─ Gemini 2.5 Flash / 3 Flash                    │
│    ├─ OpenAI GPT-4o-mini / GPT-5 mini               │
│    └─ Claude Haiku 3.5                               │
│                                                     │
│  [出力モジュール] output_manager                      │
│    ├─ カーソル位置直接挿入（SendInput / Ctrl+V）      │
│    └─ フローティングポップアップ（フォールバック）     │
│                                                     │
│  [UIモジュール] ui_manager                            │
│    ├─ システムトレイ常駐                              │
│    ├─ 録音中インジケーター                            │
│    ├─ リアルタイムプレビューウィンドウ                 │
│    └─ フォールバックポップアップ                      │
│                                                     │
│  [設定モジュール] settings_manager                    │
│    ├─ ショートカットキー割り当て                      │
│    ├─ LLMプロバイダー / モデル選択                    │
│    ├─ APIキー管理                                    │
│    ├─ 整形プロンプトの編集                            │
│    └─ STTエンジン選択                                │
│                                                     │
│  [履歴モジュール] history_manager                     │
│    └─ 文字起こし結果の保存・参照                      │
│                                                     │
│  [システムモジュール] system_manager                  │
│    ├─ PC起動時の自動起動（スタートアップ登録）         │
│    └─ バックグラウンド常駐管理                        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

## 4. 技術スタック

| レイヤー | 技術 | 選定理由 |
|---|---|---|
| 言語 | Python 3.11+ | AI/音声系ライブラリが豊富、開発速度が速い |
| STT（デフォルト） | Windows Speech Recognition API（`speech_recognition`ライブラリ経由） | PC負荷ゼロ、追加インストール不要、リアルタイム性最高 |
| STT（オプション） | faster-whisper | 高精度ローカル処理、GPU活用可能時の選択肢 |
| LLM（デフォルト） | Google Gemini 2.5 Flash-Lite API | 最安クラス（$0.10/$0.40 per 1M tokens）、無料枠あり（1日1,000クエリ） |
| LLM（オプション） | OpenAI API / Anthropic Claude API | 設定画面から切り替え可能 |
| 音声入力 | sounddevice または PyAudio | マイク入力のキャプチャ |
| キーボードフック | keyboard ライブラリ | Low-Level Hook対応、suppress機能でキー占拠可能 |
| クリップボード | pyperclip | テキストのコピー&ペースト |
| GUI | tkinter（メインUI）+ pystray（システムトレイ） | 標準ライブラリベースで軽量、追加インストール最小限 |
| 設定保存 | JSON ファイル | シンプルで編集しやすい |
| 自動起動 | Windowsスタートアップフォルダ / レジストリ | OS標準の仕組みを利用 |

---

## 5. LLM整形設計

### 5.1 デフォルト整形プロンプト（Phase 1）

```
あなたは音声文字起こしの整形アシスタントです。
以下の音声文字起こし生テキストを、そのまま使える自然な日本語の書き言葉に整形してください。

【ルール】
1. 「あー」「えーと」「まあ」「なんか」などのフィラー（言い淀み）を完全に削除する
2. 文脈に合わせて適切な句読点（、。）を付与する
3. 適切な位置で改行・段落分けを行う
4. 話し言葉を自然な書き言葉に変換する（意味は変えない）
5. 明らかな言い間違いや重複表現を修正する
6. 漢字変換の誤りを文脈から推測して修正する
7. 元の発話の意図・内容を一切変えない（要約しない、情報を追加しない）

【出力】
整形後のテキストのみを出力してください。説明や補足は一切不要です。

【音声文字起こし生テキスト】
{raw_text}
```

### 5.2 コスト設計

| 項目 | 値 |
|---|---|
| デフォルトLLM | Gemini 2.5 Flash-Lite |
| 入力料金 | $0.10 / 1M tokens |
| 出力料金 | $0.40 / 1M tokens |
| 1回の入力トークン数（平均） | 約350 tokens（プロンプト200 + 生テキスト150） |
| 1回の出力トークン数（平均） | 約150 tokens |
| **1回あたりのコスト** | **約0.017円** |
| **無料枠** | **1日1,000クエリ（月30,000クエリ相当）** |

#### 月間コスト試算
| 使用パターン | 1日の使用回数 | 月間回数 | 無料枠内？ | 月額コスト |
|---|---|---|---|---|
| 軽い使用 | 10回/日 | 300回 | ✅ 無料 | **0円** |
| 普通の使用 | 30回/日 | 900回 | ✅ 無料 | **0円** |
| ヘビーユース | 100回/日 | 3,000回 | ✅ 無料 | **0円** |
| 超ヘビーユース | 200回/日 | 6,000回 | ✅ 無料 | **0円** |
| 異常使用 | 1,500回/日 | 45,000回 | ❌ 15,000回超過 | **約255円** |

※ 現実的な使用量であれば、**Geminiの無料枠内で完全に収まる**。無料枠を超過した場合のみ従量課金となる。

---

## 6. ショートカットキー設計

### 6.1 キー占拠の仕組み

Windows の `SetWindowsHookEx` + `WH_KEYBOARD_LL`（低レベルキーボードフック）を使用し、登録されたホットキーのイベントを **他アプリに到達する前にキャッチ・消費（suppress）** する。

```python
# 概念コード
import keyboard

# 登録されたキーを占拠し、元のアプリ機能を無効化
keyboard.hook_key(registered_key, callback=on_hotkey, suppress=True)
```

### 6.2 デフォルトキー割り当て

| モード | デフォルトキー | 動作 |
|---|---|---|
| プッシュトゥトーク | 右Alt | 長押しで録音、離すと停止→整形→挿入 |
| ハンズフリー | F2 | 1回押しで録音開始、もう1回で停止→整形→挿入 |

※ 設定画面から任意のキーに変更可能（Alt、Ctrl、Shift、F1〜F12、Windowsキー等すべて対応）

### 6.3 キー占拠の安全設計

- アプリがフォアグラウンドの設定画面を表示中は、キー占拠を一時解除（設定操作を妨げないため）
- 設定画面でキー割り当てを変更する際は「新しいキーを押してください」方式で直感的に設定
- 緊急停止: Ctrl+Shift+Escなどの特定コンビネーションは常に占拠対象外とする（タスクマネージャーへのアクセスを保証）

---

## 7. UI設計

### 7.1 システムトレイ

```
タスクバー右下に常駐アイコン

[右クリックメニュー]
  ├─ 録音モード: プッシュトゥトーク / ハンズフリー
  ├─ ───────────
  ├─ 設定
  ├─ 履歴
  ├─ ───────────
  └─ 終了
```

### 7.2 録音中インジケーター

録音中は画面の目立たない位置（右上等）に小さなインジケーターを表示。

```
┌──────────────────────┐
│ 🎙 録音中...          │
│ [生テキストプレビュー] │
└──────────────────────┘
```

### 7.3 フォールバックポップアップ

テキストボックス未選択時に画面中央下に表示。

```
┌─────────────────────────────────────┐
│                                     │
│  [整形済みテキスト表示エリア]        │
│                                     │
│          [コピー]  [閉じる]         │
└─────────────────────────────────────┘
```

### 7.4 設定画面

```
┌─ 指いらず 設定 ─────────────────────────────────┐
│                                                 │
│  ■ ショートカットキー                            │
│    プッシュトゥトーク: [右Alt      ] [変更]      │
│    ハンズフリー:       [F2         ] [変更]      │
│    キー占拠:           [✅ ON]                   │
│                                                 │
│  ■ 音声認識（STT）                               │
│    エンジン: [Windows標準 ▼]                     │
│                                                 │
│  ■ AI整形（LLM）                                 │
│    プロバイダー: [Google Gemini ▼]               │
│    モデル:       [2.5 Flash-Lite ▼]             │
│    APIキー:      [●●●●●●●●●●●●   ] [表示]      │
│                                                 │
│  ■ 整形プロンプト                                │
│    [──────────────────────────────]              │
│    [  （カスタマイズ可能なテキストエリア）  ]     │
│    [──────────────────────────────]              │
│                                                 │
│  ■ 起動設定                                      │
│    PC起動時に自動起動: [✅ ON]                    │
│                                                 │
│               [保存]  [キャンセル]               │
└─────────────────────────────────────────────────┘
```

---

## 8. 開発ロードマップ

### Phase 1: 基本機能（MVP）
**目標: 「話す→整形→貼り付け」の基本パイプラインを動かす**

| ステップ | 内容 | 成果物 |
|---|---|---|
| 1-1 | プロジェクト構成・依存関係の整備 | requirements.txt、ディレクトリ構造 |
| 1-2 | 音声キャプチャモジュール実装 | マイク入力の取得・WAV保存 |
| 1-3 | STTモジュール実装（Windows標準） | 音声→生テキスト変換 |
| 1-4 | LLM整形モジュール実装（Gemini） | 生テキスト→整形済みテキスト |
| 1-5 | ホットキー管理実装（suppress付き） | キー占拠＋録音開始/停止制御 |
| 1-6 | 出力モジュール実装 | カーソル位置挿入＋フォールバックポップアップ |
| 1-7 | プッシュトゥトーク統合テスト | 長押し→話す→離す→貼り付けの一連動作確認 |
| 1-8 | ハンズフリーモード統合テスト | トグル録音→全文整形→貼り付けの一連動作確認 |

### Phase 2: UI・常駐化
**目標: 日常使いできるWindowsアプリとして完成させる**

| ステップ | 内容 |
|---|---|
| 2-1 | システムトレイ常駐の実装 |
| 2-2 | 録音中インジケーター表示 |
| 2-3 | リアルタイムプレビューウィンドウ |
| 2-4 | 設定画面の実装（キー割当、LLM選択、APIキー、プロンプト編集） |
| 2-5 | PC起動時の自動起動設定 |
| 2-6 | 設定のJSON保存・読み込み |

### Phase 3: 品質向上・拡張
**目標: 整形品質と利便性をAqua Voice/Typelessレベルに近づける**

| ステップ | 内容 |
|---|---|
| 3-1 | 履歴管理機能 |
| 3-2 | ユーザー辞書機能 |
| 3-3 | 文脈判定整形（メール/Markdown/カジュアル等の自動判定） |
| 3-4 | STTエンジンの切り替え機能（Faster Whisper対応） |
| 3-5 | LLMプロバイダー切り替え機能（OpenAI/Claude対応） |
| 3-6 | 録音インジケーター改善（音声レベルメーター） |

### Phase 4: 最終仕上げ
**目標: 配布可能なアプリケーションとして完成**

| ステップ | 内容 |
|---|---|
| 4-1 | exe化（PyInstaller等） |
| 4-2 | インストーラー作成 |
| 4-3 | エラーハンドリング・ログ機能強化 |
| 4-4 | README・ドキュメント整備 |

---

## 9. exe化について

**結論: 可能です。** Pythonで書いたアプリを、Pythonが入っていないPCでも動く単体の `.exe` にできます。

### 9.1 主な方法

| ツール | 特徴 | 指いらずでの想定 |
|---|---|---|
| **PyInstaller** | 最もよく使われる。1ファイル or 1フォルダ形式で出力可能 | **推奨**。ドキュメントが多く、問題が出たときの情報も多い |
| cx_Freeze | ライセンスが緩い。やや設定が細かい | 代替候補 |
| Nuitka | PythonをCにコンパイル。起動が速くexeが軽くなりやすい | ビルド時間が長い。上級者向け |

### 9.2 PyInstallerでの基本的な流れ（Phase 4で実施）

```bash
# インストール
pip install pyinstaller

# 1ファイルでまとめる場合（配布は1個のexeで済むが、起動はやや遅い）
pyinstaller --onefile --windowed --name "指いらず" main.py

# フォルダ形式の場合（起動が速い。フォルダごと配布）
pyinstaller --windowed --name "指いらず" main.py
```

- `--windowed`: コンソール窓を出さない（トレイ常駐アプリ向け）
- `--onefile`: 1つのexeにまとめる（解凍に数秒かかることがある）
- アイコンを付ける場合は `--icon=icon.ico` を追加

### 9.3 注意点

| 項目 | 内容 |
|---|---|
| サイズ | Pythonランタイムやライブラリが含まれるため、exeは数十MB〜100MB程度になることがある |
| 起動時間 | `--onefile` の場合、初回起動時に解凍が入るため数秒かかることがある |
| ウィルス対策 | 自作exeは一部のセキュリティソフトで「不審」と出ることがある（PyInstallerでよくある現象） |
| 管理者権限 | キー占拠で問題が出る場合、exeの「管理者として実行」が必要になることがある |

Phase 4で、上記を踏まえてexe化とインストーラー作成を行います。

---

## 10. ディレクトリ構成（予定）

```
voice-mojiokoshi-AI/
├── main.py                     # エントリーポイント
├── requirements.txt            # 依存パッケージ
├── config.json                 # ユーザー設定ファイル
├── README.md
├── アプリ作成計画書.md
├── 事前調査.md
│
├── core/                       # コアモジュール
│   ├── __init__.py
│   ├── input_manager.py        # ホットキー管理・モード制御
│   ├── audio_capture.py        # マイク音声キャプチャ
│   ├── output_manager.py       # カーソル位置挿入・クリップボード
│   └── system_manager.py       # 自動起動・常駐管理
│
├── stt/                        # STTモジュール（差し替え可能）
│   ├── __init__.py
│   ├── base.py                 # STT基底クラス（インターフェース）
│   ├── windows_stt.py          # Windows標準STT実装
│   └── whisper_stt.py          # Faster Whisper実装（Phase 3）
│
├── llm/                        # LLM整形モジュール（差し替え可能）
│   ├── __init__.py
│   ├── base.py                 # LLM基底クラス（インターフェース）
│   ├── gemini_formatter.py     # Gemini実装
│   ├── openai_formatter.py     # OpenAI実装（Phase 3）
│   └── claude_formatter.py     # Claude実装（Phase 3）
│
├── ui/                         # UIモジュール
│   ├── __init__.py
│   ├── tray_icon.py            # システムトレイアイコン
│   ├── indicator.py            # 録音中インジケーター
│   ├── popup.py                # フォールバックポップアップ
│   └── settings_window.py      # 設定画面
│
└── utils/                      # ユーティリティ
    ├── __init__.py
    ├── settings.py             # 設定管理（JSON読み書き）
    └── history.py              # 履歴管理（Phase 3）
```

---

## 11. 依存パッケージ（Phase 1）

```
google-generativeai    # Gemini API
SpeechRecognition      # Windows標準STTへのアクセス
sounddevice            # マイク音声キャプチャ
numpy                  # 音声データ処理
keyboard               # グローバルホットキー（suppress対応）
pyperclip              # クリップボード操作
pystray                # システムトレイアイコン
Pillow                 # pystrayが依存するアイコン画像処理
```

---

## 12. リスクと対策

| リスク | 影響 | 対策 |
|---|---|---|
| Windows標準STTの日本語精度が実用レベルに達しない | 整形後の文章品質低下 | STTモジュールをFaster Whisperに差し替え可能な設計 |
| Gemini無料枠の上限変更・廃止 | コスト増加 | LLMモジュールをOpenAI/Claudeに切り替え可能な設計 |
| キー占拠が特定アプリで動作しない | 一部アプリでショートカットが競合 | 管理者権限での実行オプション、競合キーの回避設定 |
| LLM整形の遅延（2秒超） | ユーザー体験の低下 | ストリーミングレスポンス対応、軽量モデルの選択 |
| APIキーの漏洩 | セキュリティリスク | 設定ファイルの暗号化、.gitignore設定 |

---

## 13. 補足事項

### 13.1 セキュリティ方針
- 使いやすさを最優先とする（セキュリティとのトレードオフが発生した場合は使いやすさを取る）
- ただしAPIキーはconfig.jsonに保存し、.gitignoreで管理対象外とする
- 音声データはローカル一時ファイルとして処理後に削除する

### 13.2 テスト方針
- 各モジュールごとにユニットテストを実施
- Phase 1完了時に統合テストとして、一連の操作フロー（キー押下→録音→STT→LLM→貼り付け）を実機で確認
- 複数のアプリ（メモ帳、ブラウザ、Slack、VSCode等）でキー占拠と貼り付けの動作確認

### 13.3 参考情報
- 事前調査.md: Mac版の自作事例とWindows版への移植検討
- Aqua Voice: https://withaqua.com/
- Typeless: https://www.typeless.com/
- Voice OS: https://www.voiceos.com/
- 喋ラボ LLM補正研究: https://www.shabelab.com/posts/test-time-compute-for-japanese-asr-a-preliminary-study-on-reducing-errors-via-llm-post-editing-of-whisper-outputs
